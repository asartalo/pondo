test:
  post:
    - bundle exec rails coveralls:push

general:
  artifacts:
    - "coverage"

machine:
  post:
    - "mv ~/$CIRCLE_PROJECT_REPONAME/.ruby-version ~/$CIRCLE_PROJECT_REPONAME/.ruby-version.ci"
    - |
      RUBY_VERSION=`cat ~/$CIRCLE_PROJECT_REPONAME/.ruby-version.ci`
      if [[ -e ~/rvm_binaries/ruby-$RUBY_VERSION.tar.bz2 ]]
      then
        rvm mount ~/rvm_binaries/ruby-$RUBY_VERSION.tar.bz2
      else
        mkdir ~/rvm_binaries || true
        rvm install $RUBY_VERSION
        gem install bundler
        cd ~/rvm_binaries && rvm prepare $RUBY_VERSION
        ls ~/rvm_binaries
      fi

dependencies:
  cache_directories:
    # We will store packages in this directory
    - ~/deps
    - ~/rvm_binaries

  pre:
    - ruby circle_ci_dependencies.rb

  override:
    - gem install bundle
    - bundle install
