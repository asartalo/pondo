test:
  post:
    - bundle exec rails coveralls:push

general:
  artifacts:
    - "coverage"

machine:
  post:
    - "mv ~/$CIRCLE_PROJECT_REPONAME/.ruby-version ~/$CIRCLE_PROJECT_REPONAME/.ruby-version.ci"
    - "mv ~/$CIRCLE_PROJECT_REPONAME/.ruby-gemset ~/$CIRCLE_PROJECT_REPONAME/.ruby-gemset.ci"
    - |
      RUBY_VERSION=`cat ~/$CIRCLE_PROJECT_REPONAME/.ruby-version.ci`
      if [[ -e ~/rvm_binaries/ruby-$RUBY_VERSION.tar.bz2 ]]
      then
        echo "YAS! We already have $RUBY_VERSION"
        rvm mount ~/rvm_binaries/ruby-$RUBY_VERSION.tar.bz2
      else
        echo "Okay installing ruby"
        mkdir ~/rvm_binaries || true
        rvm install $RUBY_VERSION
        gem install bundler
        cd ~/rvm_binaries && rvm prepare $RUBY_VERSION
        ls ~/rvm_binaries
      fi
    # - |
    #   RUBY_GEMSET=`cat ~/$CIRCLE_PROJECT_REPONAME/.ruby-gemset.ci`
    #   mkdir ~/rvm_gems || true
    #   rvm gemset create $RUBY_GEMSET
    #   rvm gemset use $RUBY_GEMSET
    #   echo "rvm gemset use $RUBY_GEMSET" > .rvmrc
    #   rvm rvmrc trust

dependencies:
  cache_directories:
    # We will store packages in this directory
    # - ~/deps
    - ~/rvm_binaries
    - /opt/circleci/.rvm/gems/

  pre:
    - ruby circle_ci_dependencies.rb

  override:
    - gem install bundle
    - bundle install
